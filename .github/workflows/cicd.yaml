name: Fractal CI/CD

on:
  push:
    branches: ["main"]

jobs:

###############################################################################
# 1️⃣ BACKEND BUILD + PUSH
###############################################################################
  backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build backend image
      run: |
        docker build -t aneesuk/backend:blue ./backend
        docker tag aneesuk/backend:blue aneesuk/backend:latest

    - name: Push backend image
      run: |
        docker push aneesuk/backend:blue
        docker push aneesuk/backend:latest

###############################################################################
# 2️⃣ FRONTEND BUILD + PUSH
###############################################################################
  frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build frontend image
      run: |
        docker build -t aneesuk/frontend:blue ./frontend
        docker tag aneesuk/frontend:blue aneesuk/frontend:latest

    - name: Push frontend image
      run: |
        docker push aneesuk/frontend:blue
        docker push aneesuk/frontend:latest

###############################################################################
# 3️⃣ DEPLOY TO AKS (BLUE ACTIVE)
###############################################################################
  deploy:
    needs: [backend, frontend]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS Credentials
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ secrets.AKS_RG }}
        cluster-name: ${{ secrets.AKS_CLUSTER }}

    - name: Deploy MySQL
      run: kubectl apply -f k8s/mysql-deployment.yaml

    - name: Deploy Backend Blue/Green
      run: kubectl apply -f k8s/backend/backend-bluegreen.yaml

    - name: Deploy Frontend Blue/Green
      run: kubectl apply -f k8s/frontend/frontend-bluegreen.yaml

    - name: Switch service to BLUE
      run: |
        kubectl patch service backend -p '{"spec":{"selector":{"version":"blue","app":"backend"}}}'
        kubectl patch service frontend -p '{"spec":{"selector":{"version":"blue","app":"frontend"}}}'
