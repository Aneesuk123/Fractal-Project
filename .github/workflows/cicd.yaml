name: Fractal CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set service env
        run: echo "SERVICE=${{ matrix.service }}" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build -t aneesuk123/${SERVICE}:blue -t aneesuk123/${SERVICE}:latest ./${SERVICE}

      - name: Scan Docker image with Trivy
        run: |
          trivy image --exit-code 1 --severity HIGH,CRITICAL aneesuk123/${SERVICE}:blue

      - name: Push Docker image
        run: |
          docker push aneesuk123/${SERVICE}:blue
          docker push aneesuk123/${SERVICE}:latest

  deploy:
    needs: build-and-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_CLUSTER }}

      - name: Determine next color (BLUE/GREEN)
        id: next-color
        run: |
          BACKEND_CUR=$(kubectl get svc backend-service -o jsonpath='{.spec.selector.version}' || echo green)
          FRONTEND_CUR=$(kubectl get svc frontend-service -o jsonpath='{.spec.selector.version}' || echo green)
          echo "BACKEND_NEXT=$( [ "$BACKEND_CUR" = "blue" ] && echo green || echo blue )" >> $GITHUB_OUTPUT
          echo "FRONTEND_NEXT=$( [ "$FRONTEND_CUR" = "blue" ] && echo green || echo blue )" >> $GITHUB_OUTPUT

      - name: Deploy MySQL & Apps
        run: |
          kubectl apply -f k8s/mysql-deployment.yaml
          kubectl apply -f k8s/backend/backend-bluegreen.yaml
          kubectl apply -f k8s/frontend/frontend-bluegreen.yaml

      - name: Switch services to next color
        run: |
          kubectl patch service backend-service -p "{\"spec\":{\"selector\":{\"app\":\"backend\",\"version\":\"${{ steps.next-color.outputs.BACKEND_NEXT }}\"}}}"
          kubectl patch service frontend-service -p "{\"spec\":{\"selector\":{\"app\":\"frontend\",\"version\":\"${{ steps.next-color.outputs.FRONTEND_NEXT }}\"}}}"

      - name: Wait for pods to be ready
        run: |
          kubectl rollout status deployment/backend-${{ steps.next-color.outputs.BACKEND_NEXT }} --timeout=120s
          kubectl rollout status deployment/frontend-${{ steps.next-color.outputs.FRONTEND_NEXT }} --timeout=120s

      - name: Health check
        run: |
          BACKEND_URL="http://$(kubectl get svc backend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'):8080/health"
          FRONTEND_URL="http://$(kubectl get svc frontend-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'):80/health"

          for url in $BACKEND_URL $FRONTEND_URL; do
            echo "Checking $url"
            for i in {1..10}; do
              status=$(curl -s -o /dev/null -w "%{http_code}" $url || echo 000)
              if [[ "$status" == "200" ]]; then
                echo "$url is healthy"
                break
              fi
              echo "Retrying $i..."
              sleep 5
              if [[ "$i" == "10" ]]; then
                echo "$url failed health check!"
                exit 1
              fi
            done
          done

      - name: Rollback if failed
        if: failure()
        run: |
          echo "Rolling back services to previous color"
          BACKEND_PREV=$( [ "${{ steps.next-color.outputs.BACKEND_NEXT }}" = "blue" ] && echo green || echo blue )
          FRONTEND_PREV=$( [ "${{ steps.next-color.outputs.FRONTEND_NEXT }}" = "blue" ] && echo green || echo blue )
          kubectl patch service backend-service -p "{\"spec\":{\"selector\":{\"app\":\"backend\",\"version\":\"$BACKEND_PREV\"}}}"
          kubectl patch service frontend-service -p "{\"spec\":{\"selector\":{\"app\":\"frontend\",\"version\":\"$FRONTEND_PREV\"}}}"
          exit 1
