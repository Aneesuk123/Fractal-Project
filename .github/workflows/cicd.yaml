name: Fractal CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image tags
        id: image-tags
        run: |
          echo "SERVICE=${{ matrix.service }}" >> $GITHUB_ENV
          echo "BLUE_TAG=${{ matrix.service }}-blue" >> $GITHUB_ENV
          echo "GREEN_TAG=${{ matrix.service }}-green" >> $GITHUB_ENV
          echo "LATEST_TAG=${{ matrix.service }}-latest" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build -t aneesuk123/${SERVICE}:blue -t aneesuk123/${SERVICE}:latest ./${SERVICE}

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: aneesuk123/${SERVICE}:blue
          format: table
          exit-code: 1        # âŒ Fail workflow if HIGH/CRITICAL found
          vuln-type: os,library
          severity: HIGH,CRITICAL

      - name: Push Docker image
        run: |
          docker push aneesuk123/${SERVICE}:blue
          docker push aneesuk123/${SERVICE}:latest

  deploy:
    needs: build-and-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RG }}
          cluster-name: ${{ secrets.AKS_CLUSTER }}

      - name: Determine next color (BLUE/GREEN)
        id: next-color
        run: |
          BACKEND_CUR=$(kubectl get svc backend-service -o jsonpath='{.spec.selector.version}' || echo green)
          FRONTEND_CUR=$(kubectl get svc frontend-service -o jsonpath='{.spec.selector.version}' || echo green)
          echo "BACKEND_NEXT=$( [ "$BACKEND_CUR" = "blue" ] && echo green || echo blue )" >> $GITHUB_OUTPUT
          echo "FRONTEND_NEXT=$( [ "$FRONTEND_CUR" = "blue" ] && echo green || echo blue )" >> $GITHUB_OUTPUT

      - name: Deploy MySQL & Apps
        run: |
          kubectl apply -f k8s/mysql-deployment.yaml
          kubectl apply -f k8s/backend/backend-bluegreen.yaml
          kubectl apply -f k8s/frontend/frontend-bluegreen.yaml

      - name: Switch services to next color
        run: |
          kubectl patch service backend-service -p "{\"spec\":{\"selector\":{\"app\":\"backend\",\"version\":\"${{ steps.next-color.outputs.BACKEND_NEXT }}\"}}}"
          kubectl patch service frontend-service -p "{\"spec\":{\"selector\":{\"app\":\"frontend\",\"version\":\"${{ steps.next-color.outputs.FRONTEND_NEXT }}\"}}}"

      - name: Verify deployment
        run: |
          echo "Backend service version:"
          kubectl get svc backend-service -o jsonpath='{.spec.selector.version}'
          echo "Frontend service version:"
          kubectl get svc frontend-service -o jsonpath='{.spec.selector.version}'
