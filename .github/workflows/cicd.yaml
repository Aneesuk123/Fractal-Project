name: Fractal CI/CD

on:
  push:
    branches: ["main"]

jobs:

###############################################################################
# 1️⃣ BACKEND BUILD + PUSH + SCAN
###############################################################################
  backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build backend image
      run: |
        docker build -t aneesuk123/backend:blue -t aneesuk123/backend:latest ./backend

    - name: Scan backend image with Trivy
      uses: aquasecurity/trivy-action@v0.28.0
      with:
        image-ref: aneesuk123/backend:blue
        format: table
        exit-code: 0
        vuln-type: os,library
        severity: HIGH,CRITICAL

    - name: Push backend image
      run: |
        docker push aneesuk123/backend:blue
        docker push aneesuk123/backend:latest

###############################################################################
# 2️⃣ FRONTEND BUILD + PUSH + SCAN
###############################################################################
  frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build frontend image
      run: |
        docker build -t aneesuk123/frontend:blue -t aneesuk123/frontend:latest ./frontend

    - name: Scan frontend image with Trivy
      uses: aquasecurity/trivy-action@v0.1.5
      with:
        image-ref: aneesuk123/frontend:blue
        format: table
        exit-code: 0
        vuln-type: os,library
        severity: HIGH,CRITICAL

    - name: Push frontend image
      run: |
        docker push aneesuk123/frontend:blue
        docker push aneesuk123/frontend:latest

###############################################################################
# 3️⃣ DEPLOY TO AKS (BLUE ACTIVE)
###############################################################################
  deploy:
    needs: [backend, frontend]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS Context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ secrets.AKS_RG }}
        cluster-name: ${{ secrets.AKS_CLUSTER }}

    - name: Deploy MySQL
      run: kubectl apply -f k8s/mysql-deployment.yaml

    - name: Deploy Backend Blue/Green
      run: kubectl apply -f k8s/backend/backend-bluegreen.yaml

    - name: Deploy Frontend Blue/Green
      run: kubectl apply -f k8s/frontend/frontend-bluegreen.yaml

    - name: Switch services to BLUE
      run: |
        kubectl patch service backend-service -p '{"spec":{"selector":{"version":"blue","app":"backend"}}}'
        kubectl patch service frontend-service -p '{"spec":{"selector":{"version":"blue","app":"frontend"}}}'
